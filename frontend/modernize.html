<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AS/400 Legacy Modernization Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.min.js"></script>
    <style>
        :root {
            --text-secondary: #9CA3AF;
        }

        .glass-card {
            background: rgba(26, 26, 26, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 140, 0, 0.2);
        }

        .gradient-text {
            background: linear-gradient(135deg, #FF8C00 0%, #FFD700 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .accent-gradient-text {
            background: linear-gradient(135deg, #FF8C00 0%, #FFD700 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF8C00 0%, #FFD700 100%);
            box-shadow: 0 8px 24px rgba(255, 140, 0, 0.3);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(255, 140, 0, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid rgba(255, 140, 0, 0.6);
            color: #CCCCCC;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 140, 0, 0.1);
            border-color: rgba(255, 140, 0, 0.8);
        }

        .tab-active {
            background: linear-gradient(135deg, #FF8C00 0%, #FFD700 100%);
            color: #111111;
        }

        .tab-inactive {
            background: transparent;
            color: #CCCCCC;
            border: 1px solid rgba(255, 140, 0, 0.3);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .error-message {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .service-node {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .service-node:hover {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        .connection-line {
            transition: stroke-width 0.2s ease;
        }

        .connection-line:hover {
            stroke-width: 3;
        }

        .diagram-container {
            background: radial-gradient(circle at 50% 50%, rgba(255, 140, 0, 0.05) 0%, transparent 70%);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Hidden file inputs -->
    <input type="file" id="copybook-input" accept=".cpy" hidden>
    <input type="file" id="data-input" accept=".dat" hidden>

    <!-- Background gradient -->
    <div class="fixed inset-0 bg-gradient-to-br from-gray-900 via-gray-800 to-black"></div>
    <div class="fixed inset-0 bg-gradient-to-r from-orange-500/5 via-transparent to-yellow-500/5"></div>

    <!-- Main content -->
    <div class="relative z-10 min-h-screen">
        <!-- Header -->
        <header class="py-8 px-4">
            <div class="max-w-4xl mx-auto text-center">
                <h1 class="text-5xl font-bold mb-4">
                    <span class="gradient-text">AS/400</span>
                    <span class="text-white">Legacy Modernization</span>
                </h1>
                <p class="text-xl text-gray-300 max-w-2xl mx-auto">
                    Transform your COBOL legacy systems into modern web applications with AI-powered analysis
                </p>
            </div>
        </header>

        <!-- Upload Section -->
        <section class="py-12 px-4">
            <div class="max-w-4xl mx-auto">
                <div class="glass-card rounded-2xl p-8">
                    <h2 class="text-3xl font-bold text-center mb-8">
                        🚀 <span class="gradient-text">Upload Your Legacy Files</span>
                    </h2>

                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                        <!-- Copybook File -->
                        <div class="glass-card rounded-xl p-6">
                            <div class="text-center">
                                <div class="text-4xl mb-4">📋</div>
                                <h3 class="text-xl font-semibold mb-2">COBOL Copybook</h3>
                                <p class="text-gray-400 mb-4">Upload your .cpy file containing the data structure definitions</p>
                                <button id="copybook-btn" class="btn-secondary px-6 py-3 rounded-lg font-medium">
                                    Select Copybook (.cpy)
                                </button>
                                <div id="copybook-status" class="mt-2 text-sm text-gray-400"></div>
                            </div>
                        </div>

                        <!-- Data File -->
                        <div class="glass-card rounded-xl p-6">
                            <div class="text-center">
                                <div class="text-4xl mb-4">💾</div>
                                <h3 class="text-xl font-semibold mb-2">Legacy Data</h3>
                                <p class="text-gray-400 mb-4">Upload your .dat file containing the actual data records</p>
                                <button id="data-btn" class="btn-secondary px-6 py-3 rounded-lg font-medium">
                                    Select Data (.dat)
                                </button>
                                <div id="data-status" class="mt-2 text-sm text-gray-400"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="text-center">
                        <button id="modernize-btn" class="btn-primary px-12 py-4 rounded-xl text-xl font-bold text-black">
                            🔥 Ignite Modernization
                        </button>

                        <!-- Loading Spinner -->
                        <div id="loading-spinner" class="hidden mt-8">
                            <div class="flex items-center justify-center">
                                <div class="spinner w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full"></div>
                                <span class="ml-3 text-lg">Analyzing and modernizing your legacy files...</span>
                            </div>
                        </div>

                        <!-- Error Message -->
                        <div id="error-message" class="hidden mt-4 p-4 bg-red-900/50 border border-red-500 rounded-lg text-red-200"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results-section" class="hidden py-12 px-4">
            <div class="max-w-6xl mx-auto">
                <div class="glass-card rounded-2xl p-8">
                    <h2 class="text-3xl font-bold text-center mb-8">
                        ✨ <span class="gradient-text">Modernization Results</span>
                    </h2>

                    <!-- The Insight Engine -->
                    <div id="insight-engine-card" class="glass-card rounded-xl p-6 mb-8 border-2 border-amber-400">
                        <h3 class="text-2xl font-bold text-center mb-4 accent-gradient-text">The Insight Engine</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div>
                                <p class="text-sm font-semibold" style="color: var(--text-secondary);">MANUAL EFFORT</p>
                                <p id="manual-hours" class="text-xl font-bold">--</p>
                                <p id="manual-timeline" class="text-sm" style="color: var(--text-secondary);">--</p>
                            </div>
                            <div>
                                <p class="text-sm font-semibold" style="color: var(--text-secondary);">ESTIMATED COST (USD)</p>
                                <p id="manual-cost" class="text-3xl font-bold text-red-500">--</p>
                            </div>
                            <div>
                                <p class="text-sm font-semibold" style="color: var(--text-secondary);">SAVINGS w/ OUR TOOL</p>
                                <p class="text-3xl font-bold text-green-500">>85%</p>
                            </div>
                        </div>
                        <p id="insight-summary" class="text-center mt-4 text-sm" style="color: var(--text-secondary);">--</p>
                    </div>

                    <!-- Tab Navigation -->
                    <div class="flex flex-wrap justify-center gap-4 mb-8">
                        <button class="tab-btn tab-active px-6 py-3 rounded-lg font-medium" data-tab="db-schema">
                            🗄️ Database Schema
                        </button>
                        <button class="tab-btn tab-inactive px-6 py-3 rounded-lg font-medium" data-tab="rest-api">
                            🔗 REST API
                        </button>
                        <button class="tab-btn tab-inactive px-6 py-3 rounded-lg font-medium" data-tab="json-data">
                            📊 JSON Data
                        </button>
                        <button class="tab-btn tab-inactive px-6 py-3 rounded-lg font-medium" data-tab="microservices">
                            🏗️ Microservices
                        </button>
                        <button class="tab-btn tab-inactive px-6 py-3 rounded-lg font-medium" data-tab="diagram">
                            📊 Architecture
                        </button>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- Database Schema Tab -->
                        <div id="db-schema-content" class="tab-panel">
                            <h3 class="text-xl font-semibold mb-4">PostgreSQL Database Schema</h3>
                            <div class="glass-card rounded-lg p-4 bg-gray-800">
                                <pre><code class="language-sql" id="db-schema-code">-- Database schema will appear here after processing</code></pre>
                            </div>
                        </div>

                        <!-- REST API Tab -->
                        <div id="rest-api-content" class="tab-panel hidden">
                            <h3 class="text-xl font-semibold mb-4">Node.js Express REST API</h3>
                            <div class="glass-card rounded-lg p-4 bg-gray-800">
                                <pre><code class="language-javascript" id="rest-api-code">// REST API code will appear here after processing</code></pre>
                            </div>
                        </div>

                        <!-- JSON Data Tab -->
                        <div id="json-data-content" class="tab-panel hidden">
                            <h3 class="text-xl font-semibold mb-4">Converted JSON Data</h3>
                            <div class="glass-card rounded-lg p-4 bg-gray-800">
                                <pre><code class="language-json" id="json-data-code">// JSON data will appear here after processing</code></pre>
                            </div>
                        </div>

                        <!-- Microservices Tab -->
                        <div id="microservices-content" class="tab-panel hidden">
                            <h3 class="text-xl font-semibold mb-4">🏗️ Microservices Architecture</h3>

                            <!-- View Toggle -->
                            <div class="flex justify-center mb-6">
                                <div class="glass-card rounded-lg p-1 flex">
                                    <button id="diagram-view-btn" class="px-6 py-2 rounded-md bg-orange-500 text-black font-medium transition-all">
                                        🎨 Interactive Diagram
                                    </button>
                                    <button id="code-view-btn" class="px-6 py-2 rounded-md text-gray-300 font-medium transition-all hover:text-white">
                                        📝 Architecture Code
                                    </button>
                                </div>
                            </div>

                            <!-- Interactive Visual Diagram -->
                            <div id="microservices-diagram" class="mb-6">
                                <div class="glass-card rounded-lg p-6 bg-gray-800">
                                    <div class="text-center mb-4">
                                        <h4 class="text-lg font-semibold gradient-text">Interactive Microservices Architecture</h4>
                                        <p class="text-gray-400 text-sm mt-1">🖱️ Click services for details • 🎯 Drag to reposition • ✨ Hover for effects</p>
                                    </div>

                                    <!-- Diagram Container -->
                                    <div id="diagram-container" class="relative w-full h-96 border border-gray-700 rounded-lg bg-gray-900 overflow-hidden diagram-container">
                                        <!-- SVG for connections -->
                                        <svg id="microservices-svg" class="absolute inset-0 w-full h-full pointer-events-none">
                                            <defs>
                                                <marker id="arrowhead" markerWidth="10" markerHeight="7"
                                                        refX="10" refY="3.5" orient="auto">
                                                    <polygon points="0 0, 10 3.5, 0 7" fill="#FF8C00" />
                                                </marker>
                                                <filter id="glow">
                                                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                                    <feMerge>
                                                        <feMergeNode in="coloredBlur"/>
                                                        <feMergeNode in="SourceGraphic"/>
                                                    </feMerge>
                                                </filter>
                                                <linearGradient id="connectionGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                                    <stop offset="0%" style="stop-color:#FF8C00;stop-opacity:0.8" />
                                                    <stop offset="100%" style="stop-color:#FFD700;stop-opacity:0.8" />
                                                </linearGradient>
                                            </defs>
                                        </svg>

                                        <!-- Service nodes container -->
                                        <div id="services-container" class="absolute inset-0"></div>
                                    </div>

                                    <!-- Service Details Panel -->
                                    <div id="service-details" class="hidden mt-6 p-4 bg-gray-700 rounded-lg border border-orange-500/30">
                                        <div class="flex items-center justify-between mb-3">
                                            <h5 class="font-semibold text-orange-400" id="service-title">Service Details</h5>
                                            <button id="close-details" class="text-gray-400 hover:text-white">✕</button>
                                        </div>
                                        <div id="service-info" class="text-sm text-gray-300">
                                            <!-- Service details will be populated here -->
                                        </div>
                                    </div>

                                    <!-- Architecture Legend -->
                                    <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                                        <h5 class="text-sm font-semibold text-gray-300 mb-2">🏗️ Architecture Legend</h5>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                                <span class="text-gray-300">API Gateway</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                                <span class="text-gray-300">Core Services</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                                                <span class="text-gray-300">Data Services</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                                                <span class="text-gray-300">External Services</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Code View -->
                            <div id="microservices-code-view" class="hidden glass-card rounded-lg p-4 bg-gray-800">
                                <pre><code class="language-markdown" id="microservices-code"># Microservices architecture will appear here after processing</code></pre>
                            </div>
                        </div>

                        <!-- Architecture Diagram Tab -->
                        <div id="diagram-content" class="tab-panel hidden">
                            <h3 class="text-xl font-semibold mb-4">📊 Architecture Diagram</h3>
                            <div class="glass-card rounded-lg p-4 bg-gray-800">
                                <pre><code class="language-mermaid">
                                    <!-- Mermaid.js code will go here -->
                                </code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Download Section -->
                    <div class="mt-8 text-center">
                        <button id="download-btn" class="btn-secondary px-8 py-3 rounded-lg font-medium">
                            📥 Download All Assets
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // State variables
            let copybookFile = null;
            let datafileFile = null;
            let currentResults = null;
            let microservicesData = [];
            let selectedService = null;
            let isDragging = false;

            // Get DOM elements
            const copybookBtn = document.getElementById('copybook-btn');
            const copybookInput = document.getElementById('copybook-input');
            const copybookStatus = document.getElementById('copybook-status');

            const dataBtn = document.getElementById('data-btn');
            const dataInput = document.getElementById('data-input');
            const dataStatus = document.getElementById('data-status');

            const modernizeBtn = document.getElementById('modernize-btn');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessage = document.getElementById('error-message');
            const resultsSection = document.getElementById('results-section');

            // Tab elements
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');

            // Microservices diagram elements
            const diagramViewBtn = document.getElementById('diagram-view-btn');
            const codeViewBtn = document.getElementById('code-view-btn');
            const microservicesDiagram = document.getElementById('microservices-diagram');
            const microservicesCodeView = document.getElementById('microservices-code-view');

            // File selection handlers
            copybookBtn.addEventListener('click', () => {
                copybookInput.click();
            });

            dataBtn.addEventListener('click', () => {
                dataInput.click();
            });

            copybookInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    copybookFile = file;
                    copybookBtn.textContent = `✅ ${file.name}`;
                    copybookBtn.classList.remove('btn-secondary');
                    copybookBtn.classList.add('btn-primary', 'text-black');
                    copybookStatus.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                    copybookStatus.classList.add('text-green-400');
                    checkFilesReady();
                }
            });

            dataInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    datafileFile = file;
                    dataBtn.textContent = `✅ ${file.name}`;
                    dataBtn.classList.remove('btn-secondary');
                    dataBtn.classList.add('btn-primary', 'text-black');
                    dataStatus.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                    dataStatus.classList.add('text-green-400');
                    checkFilesReady();
                }
            });

            function checkFilesReady() {
                if (copybookFile && datafileFile) {
                    modernizeBtn.classList.add('animate-pulse');
                    modernizeBtn.innerHTML = '🚀 Ready to Modernize!';
                }
            }

            // Tab switching
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.dataset.tab;

                    // Update tab buttons
                    tabBtns.forEach(b => {
                        b.classList.remove('tab-active');
                        b.classList.add('tab-inactive');
                    });
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');

                    // Update tab panels
                    tabPanels.forEach(panel => {
                        panel.classList.add('hidden');
                    });
                    document.getElementById(`${targetTab}-content`).classList.remove('hidden');
                });
            });

            // Microservices view toggle handlers
            diagramViewBtn.addEventListener('click', () => {
                microservicesDiagram.classList.remove('hidden');
                microservicesCodeView.classList.add('hidden');
                diagramViewBtn.classList.add('bg-orange-500', 'text-black');
                diagramViewBtn.classList.remove('text-gray-300');
                codeViewBtn.classList.remove('bg-orange-500', 'text-black');
                codeViewBtn.classList.add('text-gray-300');
            });

            codeViewBtn.addEventListener('click', () => {
                microservicesDiagram.classList.add('hidden');
                microservicesCodeView.classList.remove('hidden');
                codeViewBtn.classList.add('bg-orange-500', 'text-black');
                codeViewBtn.classList.remove('text-gray-300');
                diagramViewBtn.classList.remove('bg-orange-500', 'text-black');
                diagramViewBtn.classList.add('text-gray-300');
            });

            // Close service details
            document.getElementById('close-details').addEventListener('click', () => {
                document.getElementById('service-details').classList.add('hidden');
                document.querySelectorAll('.service-node').forEach(node => {
                    node.classList.remove('ring-2', 'ring-orange-400');
                });
            });

            // Generate microservices architecture based on data
            function generateMicroservicesArchitecture(jsonData) {
                const baseServices = [
                    {
                        id: 'api-gateway',
                        name: 'API Gateway',
                        type: 'gateway',
                        color: '#3B82F6',
                        description: 'Central entry point for all client requests with rate limiting and authentication',
                        endpoints: ['/api/v1/*', '/auth', '/health'],
                        technologies: ['Express.js', 'Rate Limiting', 'JWT', 'CORS'],
                        position: { x: 50, y: 15 },
                        connections: ['user-service', 'data-service', 'reporting-service']
                    },
                    {
                        id: 'user-service',
                        name: 'User Service',
                        type: 'core',
                        color: '#10B981',
                        description: 'Manages user authentication, authorization, and profile management',
                        endpoints: ['/users', '/auth/login', '/auth/logout', '/profiles'],
                        technologies: ['JWT', 'bcrypt', 'Node.js', 'Passport.js'],
                        position: { x: 20, y: 45 },
                        connections: ['notification-service']
                    },
                    {
                        id: 'data-service',
                        name: 'Data Service',
                        type: 'data',
                        color: '#8B5CF6',
                        description: 'Handles converted legacy data operations with caching and optimization',
                        endpoints: ['/records', '/search', '/export', '/import'],
                        technologies: ['PostgreSQL', 'Redis', 'GraphQL', 'Elasticsearch'],
                        position: { x: 80, y: 45 },
                        connections: ['reporting-service']
                    },
                    {
                        id: 'reporting-service',
                        name: 'Reporting Service',
                        type: 'core',
                        color: '#10B981',
                        description: 'Generates dynamic reports and analytics from modernized data',
                        endpoints: ['/reports', '/analytics', '/dashboard', '/export'],
                        technologies: ['Chart.js', 'PDF Generation', 'Excel Export', 'Caching'],
                        position: { x: 50, y: 75 },
                        connections: ['notification-service']
                    },
                    {
                        id: 'notification-service',
                        name: 'Notification Service',
                        type: 'external',
                        color: '#F59E0B',
                        description: 'Handles email notifications, alerts, and real-time updates',
                        endpoints: ['/notify', '/templates', '/subscriptions', '/webhooks'],
                        technologies: ['SendGrid', 'WebSockets', 'Queue System', 'Templates'],
                        position: { x: 20, y: 85 },
                        connections: []
                    }
                ];

                // Analyze JSON data to add domain-specific services
                if (jsonData && Array.isArray(jsonData) && jsonData.length > 0) {
                    const sample = jsonData[0];
                    const fields = Object.keys(sample).map(key => key.toLowerCase());

                    // Customer/Client management service
                    if (fields.some(field => field.includes('customer') || field.includes('client') || field.includes('name'))) {
                        baseServices.push({
                            id: 'customer-service',
                            name: 'Customer Service',
                            type: 'core',
                            color: '#10B981',
                            description: 'Manages customer relationships, profiles, and interaction history',
                            endpoints: ['/customers', '/crm', '/contacts', '/history'],
                            technologies: ['CRM Integration', 'Customer API', 'Data Validation', 'Search'],
                            position: { x: 80, y: 75 },
                            connections: ['notification-service', 'data-service']
                        });

                        // Update connections
                        baseServices.find(s => s.id === 'api-gateway').connections.push('customer-service');
                    }

                    // Financial service
                    if (fields.some(field => field.includes('amount') || field.includes('price') || field.includes('cost') || field.includes('payment'))) {
                        baseServices.push({
                            id: 'financial-service',
                            name: 'Financial Service',
                            type: 'core',
                            color: '#10B981',
                            description: 'Processes financial transactions, billing, and payment operations',
                            endpoints: ['/transactions', '/billing', '/payments', '/invoices'],
                            technologies: ['Payment Gateway', 'Financial API', 'Audit Trail', 'Encryption'],
                            position: { x: 35, y: 105 },
                            connections: ['data-service', 'notification-service']
                        });

                        baseServices.find(s => s.id === 'api-gateway').connections.push('financial-service');
                    }

                    // Inventory/Product service
                    if (fields.some(field => field.includes('product') || field.includes('item') || field.includes('inventory') || field.includes('stock'))) {
                        baseServices.push({
                            id: 'inventory-service',
                            name: 'Inventory Service',
                            type: 'core',
                            color: '#10B981',
                            description: 'Manages product catalog, inventory levels, and stock operations',
                            endpoints: ['/inventory', '/products', '/stock', '/catalog'],
                            technologies: ['Inventory API', 'Stock Management', 'Barcode Scanner', 'Tracking'],
                            position: { x: 65, y: 105 },
                            connections: ['data-service', 'reporting-service']
                        });

                        baseServices.find(s => s.id === 'api-gateway').connections.push('inventory-service');
                    }
                }

                return baseServices;
            }

            // Render the interactive microservices diagram
            function renderMicroservicesDiagram(services) {
                const container = document.getElementById('services-container');
                const svg = document.getElementById('microservices-svg');

                // Clear existing content
                container.innerHTML = '';
                const defs = svg.querySelector('defs');
                svg.innerHTML = '';
                svg.appendChild(defs);

                // Draw connections first
                services.forEach(service => {
                    if (service.connections) {
                        service.connections.forEach(targetId => {
                            const targetService = services.find(s => s.id === targetId);
                            if (targetService) {
                                drawConnection(svg, service, targetService);
                            }
                        });
                    }
                });

                // Create service nodes
                services.forEach(service => {
                    createServiceNode(container, service, services);
                });
            }

            function drawConnection(svg, fromService, toService) {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', `${fromService.position.x}%`);
                line.setAttribute('y1', `${fromService.position.y}%`);
                line.setAttribute('x2', `${toService.position.x}%`);
                line.setAttribute('y2', `${toService.position.y}%`);
                line.setAttribute('stroke', 'url(#connectionGradient)');
                line.setAttribute('stroke-width', '2');
                line.setAttribute('marker-end', 'url(#arrowhead)');
                line.setAttribute('opacity', '0.7');
                line.classList.add('connection-line');
                svg.appendChild(line);
            }

            function createServiceNode(container, service, allServices) {
                const serviceNode = document.createElement('div');
                serviceNode.className = 'absolute cursor-pointer transform -translate-x-1/2 -translate-y-1/2 transition-all duration-300 hover:z-10';
                serviceNode.style.left = `${service.position.x}%`;
                serviceNode.style.top = `${service.position.y}%`;

                serviceNode.innerHTML = `
                    <div class="service-node relative p-4 rounded-xl border-2 shadow-lg hover:shadow-2xl"
                         style="background: linear-gradient(135deg, ${service.color}15, ${service.color}25); border-color: ${service.color}; min-width: 120px;"
                         data-service-id="${service.id}">
                        <div class="text-center">
                            <div class="text-xs font-bold text-white mb-1">
                                ${getServiceIcon(service.type)} ${service.name}
                            </div>
                            <div class="text-xs text-gray-300">
                                ${service.type}
                            </div>
                        </div>
                        <div class="absolute -top-1 -right-1 w-4 h-4 rounded-full pulse-animation"
                             style="background: ${service.color}; box-shadow: 0 0 10px ${service.color}50;"></div>
                        <div class="absolute inset-0 rounded-xl border-2 border-transparent hover:border-orange-400 transition-all duration-300"></div>
                    </div>
                `;

                // Click handler for service details
                serviceNode.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showServiceDetails(service);
                    highlightService(serviceNode);
                });

                // Drag functionality
                let dragStartX, dragStartY, startLeft, startTop;

                serviceNode.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                    startLeft = service.position.x;
                    startTop = service.position.y;
                    serviceNode.style.zIndex = '1000';
                    serviceNode.style.cursor = 'grabbing';
                    e.preventDefault();
                });

                container.appendChild(serviceNode);
            }

            function getServiceIcon(type) {
                const icons = {
                    'gateway': '🚪',
                    'core': '⚙️',
                    'data': '💾',
                    'external': '🌐'
                };
                return icons[type] || '🔧';
            }

            function highlightService(serviceNode) {
                // Remove previous highlights
                document.querySelectorAll('.service-node').forEach(node => {
                    node.classList.remove('ring-2', 'ring-orange-400');
                });

                // Highlight selected service
                serviceNode.querySelector('.service-node').classList.add('ring-2', 'ring-orange-400');
            }

            function showServiceDetails(service) {
                selectedService = service;
                const detailsPanel = document.getElementById('service-details');
                const titleElement = document.getElementById('service-title');
                const infoElement = document.getElementById('service-info');

                titleElement.innerHTML = `${getServiceIcon(service.type)} ${service.name}`;
                infoElement.innerHTML = `
                    <div class="grid gap-4">
                        <div>
                            <div class="font-medium text-orange-400 mb-1">📋 Description</div>
                            <div class="text-gray-300">${service.description}</div>
                        </div>
                        <div>
                            <div class="font-medium text-orange-400 mb-1">🏷️ Service Type</div>
                            <span class="inline-block px-3 py-1 rounded-full text-xs font-medium"
                                  style="background: ${service.color}20; color: ${service.color}; border: 1px solid ${service.color};">
                                ${service.type.toUpperCase()}
                            </span>
                        </div>
                        <div>
                            <div class="font-medium text-orange-400 mb-2">🔗 API Endpoints</div>
                            <div class="grid gap-1">
                                ${service.endpoints.map(endpoint =>
                                    `<span class="inline-block bg-gray-600 px-3 py-1 rounded text-xs font-mono">${endpoint}</span>`
                                ).join('')}
                            </div>
                        </div>
                        <div>
                            <div class="font-medium text-orange-400 mb-2">🛠️ Technologies</div>
                            <div class="flex flex-wrap gap-1">
                                ${service.technologies.map(tech =>
                                    `<span class="inline-block bg-blue-600 px-2 py-1 rounded text-xs">${tech}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;

                detailsPanel.classList.remove('hidden');
                detailsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Global mouse event handlers for dragging
            document.addEventListener('mousemove', (e) => {
                if (isDragging && selectedService) {
                    const container = document.getElementById('diagram-container');
                    const containerRect = container.getBoundingClientRect();

                    const deltaX = e.clientX - dragStartX;
                    const deltaY = e.clientY - dragStartY;

                    const newX = startLeft + (deltaX / containerRect.width) * 100;
                    const newY = startTop + (deltaY / containerRect.height) * 100;

                    // Keep within bounds
                    if (newX >= 5 && newX <= 95 && newY >= 5 && newY <= 95) {
                        selectedService.position.x = newX;
                        selectedService.position.y = newY;

                        // Update position immediately
                        const serviceNode = document.querySelector(`[data-service-id="${selectedService.id}"]`).parentElement;
                        serviceNode.style.left = `${newX}%`;
                        serviceNode.style.top = `${newY}%`;

                        // Redraw connections
                        renderMicroservicesDiagram(microservicesData);
                    }
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    selectedService = null;
                    document.querySelectorAll('.service-node').forEach(node => {
                        node.style.cursor = 'pointer';
                        node.style.zIndex = 'auto';
                    });
                }
            });

            // Main modernization handler
            modernizeBtn.addEventListener('click', async () => {
                // Validate files
                if (!copybookFile || !datafileFile) {
                    showError('Please select both a copybook (.cpy) and data (.dat) file before proceeding.');
                    return;
                }

                // Validate file extensions
                if (!copybookFile.name.toLowerCase().endsWith('.cpy')) {
                    showError('Copybook file must have a .cpy extension.');
                    return;
                }

                if (!datafileFile.name.toLowerCase().endsWith('.dat')) {
                    showError('Data file must have a .dat extension.');
                    return;
                }

                // Show loading state
                modernizeBtn.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                hideError();

                try {
                    // Create FormData for file upload
                    const formData = new FormData();
                    formData.append('copybook', copybookFile);
                    formData.append('datafile', datafileFile);

                    // Make actual API call to backend
                    const response = await fetch('/api/v1/modernize', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'Modernization failed');
                    }

                    // Use actual API response
                    /*
                    // Demo result structure - REMOVED FOR REAL API INTEGRATION
                    const result = {
                        success: true,
                        files: {
                            copybook: copybookFile.name,
                            datafile: datafileFile.name
                        },
                        modernizationAssets: {
                            dbSchema: `-- Generated PostgreSQL Schema for ${copybookFile.name}
CREATE TABLE legacy_data (
    id SERIAL PRIMARY KEY,
    record_id VARCHAR(50) NOT NULL,
    customer_name VARCHAR(100),
    amount DECIMAL(10,2),
    transaction_date DATE,
    status VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_legacy_data_record_id ON legacy_data(record_id);
CREATE INDEX idx_legacy_data_customer ON legacy_data(customer_name);
CREATE INDEX idx_legacy_data_date ON legacy_data(transaction_date);`,

                            restApi: `// Generated REST API for ${datafileFile.name}
const express = require('express');
const { Pool } = require('pg');
const router = express.Router();

const pool = new Pool({
    connectionString: process.env.DATABASE_URL
});

// Get all records
router.get('/records', async (req, res) => {
    try {
        const { page = 1, limit = 10 } = req.query;
        const offset = (page - 1) * limit;

        const result = await pool.query(
            'SELECT * FROM legacy_data ORDER BY created_at DESC LIMIT $1 OFFSET $2',
            [limit, offset]
        );

        res.json({
            success: true,
            data: result.rows,
            pagination: { page, limit, total: result.rowCount }
        });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

// Get record by ID
router.get('/records/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const result = await pool.query('SELECT * FROM legacy_data WHERE id = $1', [id]);

        if (result.rows.length === 0) {
            return res.status(404).json({ success: false, error: 'Record not found' });
        }

        res.json({ success: true, data: result.rows[0] });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

module.exports = router;`,

                            jsonData: [
                                {
                                    "id": 1,
                                    "record_id": "REC001",
                                    "customer_name": "John Doe",
                                    "amount": 1250.75,
                                    "transaction_date": "2024-01-15",
                                    "status": "completed"
                                },
                                {
                                    "id": 2,
                                    "record_id": "REC002",
                                    "customer_name": "Jane Smith",
                                    "amount": 3400.25,
                                    "transaction_date": "2024-01-16",
                                    "status": "pending"
                                },
                                {
                                    "id": 3,
                                    "record_id": "REC003",
                                    "customer_name": "Bob Johnson",
                                    "amount": 750.00,
                                    "transaction_date": "2024-01-17",
                                    "status": "completed"
                                }
                            ],

                            microservices: `# Microservices Architecture for Legacy System Modernization

## 🏗️ Architecture Overview
This modernized system follows a microservices architecture pattern, breaking down the monolithic AS/400 system into smaller, manageable services.

## 🚪 API Gateway
- **Purpose**: Central entry point for all client requests
- **Responsibilities**: Authentication, rate limiting, routing, load balancing
- **Technology Stack**: Express.js, JWT, Rate Limiting middleware

## ⚙️ Core Business Services

### User Service
- **Purpose**: Handle user authentication and authorization
- **Endpoints**: /users, /auth, /profiles
- **Database**: PostgreSQL with user tables

### Data Service
- **Purpose**: Manage converted legacy data operations
- **Endpoints**: /records, /search, /export
- **Database**: PostgreSQL with Redis caching

### Reporting Service
- **Purpose**: Generate reports and analytics
- **Endpoints**: /reports, /analytics, /dashboard
- **Technology**: Chart.js, PDF generation

## 💾 Data Layer
- **Primary Database**: PostgreSQL for transactional data
- **Cache Layer**: Redis for frequently accessed data
- **Search Engine**: Elasticsearch for complex queries

## 🌐 External Services
- **Notification Service**: Email and push notifications
- **File Storage**: AWS S3 or equivalent for document storage
- **Monitoring**: Application performance monitoring

## 📡 Communication Patterns
- **Synchronous**: REST APIs for real-time operations
- **Asynchronous**: Message queues for background processing
- **Event-Driven**: Event sourcing for audit trails

## 🔒 Security Considerations
- JWT tokens for authentication
- Rate limiting to prevent abuse
- Input validation and sanitization
- HTTPS encryption for all communications

## 🚀 Deployment Strategy
- **Containerization**: Docker containers for each service
- **Orchestration**: Kubernetes for container management
- **CI/CD**: Automated deployment pipelines
- **Monitoring**: Centralized logging and metrics`,

                            microserviceDiagram: `graph TD
    A[User] --> B{Load Balancer}
    B --> C[Customer Service]
    B --> D[Data Service]
    C --> E[(Customer Database)]
    D --> F[(Legacy Data)]`,

                            insightEngine: {
                                analysisTitle: "The Insight Engine",
                                manualEffort: {
                                    hours: "480-720",
                                    timeline: "3-4 months",
                                    costUSD: "$48,000-$72,000"
                                },
                                automatedTool: {
                                    time: "2-3 weeks",
                                    costUSD: "$5,000-$8,000"
                                },
                                summary: "Automated modernization tools can reduce development time by 85% and costs by 80% compared to manual migration approaches. This analysis shows significant ROI through reduced timeline and development resources."
                            }
                        }
                    };
                    */

                    // Store results from actual API
                    currentResults = result;
                    console.log('API Response received:', result);
                    console.log('Modernization Assets:', result.modernizationAssets);

                    // Populate results
                    populateResults(result.modernizationAssets);

                    // Show results section with animation
                    resultsSection.classList.remove('hidden');
                    resultsSection.classList.add('fade-in');

                    // Scroll to results
                    resultsSection.scrollIntoView({ behavior: 'smooth' });

                } catch (error) {
                    console.error('Modernization error:', error);
                    showError(`Modernization failed: ${error.message}`);
                    modernizeBtn.classList.remove('hidden');
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            });

            function populateResults(assets) {
                console.log('populateResults called with assets:', assets);

                // Populate database schema
                const dbSchemaCode = document.getElementById('db-schema-code');
                dbSchemaCode.textContent = assets.dbSchema || 'No database schema generated';

                // Populate REST API
                const restApiCode = document.getElementById('rest-api-code');
                restApiCode.textContent = assets.restApi || 'No REST API code generated';

                // Populate JSON data
                const jsonDataCode = document.getElementById('json-data-code');
                let jsonData = null;
                if (Array.isArray(assets.jsonData)) {
                    jsonData = assets.jsonData;
                    jsonDataCode.textContent = JSON.stringify(assets.jsonData, null, 2);
                } else {
                    jsonDataCode.textContent = assets.jsonData || 'No JSON data generated';
                }

                // Populate microservices text
                const microservicesCode = document.getElementById('microservices-code');
                if (Array.isArray(assets.microservices)) {
                    microservicesCode.textContent = assets.microservices.join('\n\n');
                } else {
                    microservicesCode.textContent = assets.microservices || 'No microservices suggestions generated';
                }

                // Populate Insight Engine data
                if (assets.insightEngine) {
                    console.log('Populating Insight Engine with data:', assets.insightEngine);
                    const insightEngine = assets.insightEngine;
                    document.getElementById('manual-hours').textContent = insightEngine.manualEffort.hours || '--';
                    document.getElementById('manual-timeline').textContent = insightEngine.manualEffort.timeline || '--';
                    document.getElementById('manual-cost').textContent = insightEngine.manualEffort.costUSD || '--';
                    document.getElementById('insight-summary').textContent = insightEngine.summary || 'No analysis available';
                } else {
                    console.log('No insightEngine data found in assets');
                }

                // Populate Mermaid diagram
                if (assets.microserviceDiagram) {
                    console.log('Populating Mermaid diagram with data:', assets.microserviceDiagram);
                    const diagramCode = document.querySelector('#diagram-content code');
                    diagramCode.textContent = assets.microserviceDiagram;

                    // Initialize Mermaid configuration and render the diagram
                    mermaid.initialize({ startOnLoad: false, theme: 'dark' });

                    // Use setTimeout to ensure DOM is ready for Mermaid rendering
                    setTimeout(() => {
                        console.log('Running mermaid.run()');
                        mermaid.run();
                    }, 100);
                } else {
                    console.log('No microserviceDiagram data found in assets');
                }

                // Generate and render microservices diagram
                microservicesData = generateMicroservicesArchitecture(jsonData);
                renderMicroservicesDiagram(microservicesData);

                // Apply syntax highlighting
                Prism.highlightAll();
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                errorMessage.classList.add('error-message');

                // Remove animation class after animation completes
                setTimeout(() => {
                    errorMessage.classList.remove('error-message');
                }, 500);
            }

            function hideError() {
                errorMessage.classList.add('hidden');
            }

            // Download functionality
            document.getElementById('download-btn').addEventListener('click', () => {
                if (!currentResults) {
                    showError('No results to download. Please run modernization first.');
                    return;
                }

                const assets = currentResults.modernizationAssets;
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');

                // Create comprehensive download content
                const content = `# AS/400 Legacy Modernization Results
Generated on: ${new Date().toLocaleString()}
Files: ${currentResults.files.copybook}, ${currentResults.files.datafile}

## 🗄️ Database Schema
\`\`\`sql
${assets.dbSchema}
\`\`\`

## 🔗 REST API Implementation
\`\`\`javascript
${assets.restApi}
\`\`\`

## 📊 Sample JSON Data
\`\`\`json
${typeof assets.jsonData === 'string' ? assets.jsonData : JSON.stringify(assets.jsonData, null, 2)}
\`\`\`

## 🏗️ Microservices Architecture
${Array.isArray(assets.microservices) ? assets.microservices.join('\n\n') : assets.microservices}

## 📊 Architecture Diagram (Mermaid.js)
\`\`\`mermaid
${assets.microserviceDiagram || 'No diagram generated'}
\`\`\`

## 💰 ROI Analysis - The Insight Engine
${assets.insightEngine ? `
**Manual Effort**: ${assets.insightEngine.manualEffort.hours} (${assets.insightEngine.manualEffort.timeline})
**Manual Cost**: ${assets.insightEngine.manualEffort.costUSD}
**Automated Tool Time**: ${assets.insightEngine.automatedTool.time}
**Automated Tool Cost**: ${assets.insightEngine.automatedTool.costUSD}

**Summary**: ${assets.insightEngine.summary}
` : 'No ROI analysis available'}

---
*Generated by AS/400 Legacy Modernization Assistant*
`;

                // Create and trigger download
                const blob = new Blob([content], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `modernization-results-${timestamp}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            // Initialize application
            console.log('🚀 AS/400 Legacy Modernization Assistant initialized successfully');
        });
    </script>
</body>
</html>
